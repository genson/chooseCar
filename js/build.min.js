/* choose-a-car - v0.0.3 - 2013-11-10 */
"use strict";function shuffle(a){for(var b,c,d=a.length;--d;)b=Math.floor(Math.random()*(d+1)),c=a[d],a[d]=a[b],a[b]=c;return a}function preloadImages(a,b){for(var c=new Image,d=0,e=a.length;e>d;d++)c.src=a[d].imageUrl;return b?b():!0}var myApp=angular.module("chooseCar",["ngRoute","ngTouch"]).constant("mainSettings",{dbUrl:"https://carsdb.firebaseio.com/ScoreList.json"}).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!1),a.when("/game",{templateUrl:"partials/startGame.html",controller:"StartGameCtrl"}),a.when("/records",{templateUrl:"partials/records.html",controller:"RecordsCtrl"}),a.when("/main",{templateUrl:"partials/main.html",controller:"MainCtrl"}),a.otherwise({redirectTo:"/main"})}]);myApp.controller("StartGameCtrl",["$scope","$http","$timeout","$window","mainSettings",function(a,b,c,d,e){a.userScore=0,a.bestScore=localStorage.getItem("bestScore")||0,a.attempts=3,a.canClickOnCar=!0,a.gameEnd=!1,a.timeIsUp=!1,a.progressbar={status:"",width:0};var f;b.get("cars/cars.json").success(function(b){a.carsData=shuffle(b),preloadImages(a.carsData,a.updateGame)}),a.progressbarLength=function(b){var d,b=b||1e4,e=a.progressbar.width;a.progressbar.width+=5e3/b,d=45>e?"success":70>e?"info":90>e?"warning":"danger",a.progressbar.status=d,a.progressbar.width>=100?(c.cancel(f),a.attempts--,a.canClickOnCar=!1,a.attempts>0&&!a.gameEnd?(a.timeIsUp=!0,c(function(){a.updateGame()},2e3)):0==a.attempts&&a.endGame()):a.gameEnd?c.cancel(f):f=c(a.progressbarLength,50)},a.checkChoice=function(b){if(a.canClickOnCar)if(c.cancel(f),a.canClickOnCar=!1,b.name==a.randomCarName){b.flag="choice-success";var d=Math.floor(100-a.progressbar.width);c(function(){a.updateGame(d)},1500)}else b.flag="choice-fail",a.attempts--,c(function(){a.updateGame()},1500)},a.updateGame=function(b,c){var d=[],b=b||0,c=c||4,e=Math.floor(Math.random()*c);if(a.userScore+=b,a.timeIsUp=!1,a.progressbar.width=0,a.canClickOnCar=!0,a.gameEnd||!a.attempts||!a.carsData.length)return a.endGame(),void 0;a.progressbarLength(1e4),a.carsData.length<=c&&(c=a.carsData.length,e=Math.floor(Math.random()*a.carsData.length));for(var f=0;c>f;f++)d.push(a.carsData.pop());a.randomCarName=d[e].name,a.cars=d},a.endGame=function(){a.bestScore=a.userScore>a.bestScore?a.userScore:a.bestScore,localStorage.setItem("bestScore",a.bestScore),a.cars=[],a.gameEnd=!0},a.submitScore=function(){if(!a.userName)return a.inputHasError="has-error",void 0;a.inputHasError="has-success";var c={name:a.userName,score:a.userScore};b.post(e.dbUrl,c).success(function(){a.successSubmit=!0})},a.restart=function(){d.location.reload()}}]).controller("RecordsCtrl",["$scope","$http","mainSettings",function(a,b,c){b.get(c.dbUrl).success(function(b){var c=[];for(var d in b)c.push(b[d]);a.scoreList=c})}]).controller("MainCtrl",["$scope",function(){}]),myApp.filter("orderObjectBy",function(){return function(a,b){if(!angular.isObject(a))return a;var c=[];for(var d in a)c.push(a[d]);return c.sort(function(a,c){return a=parseInt(a[b]),c=parseInt(c[b]),c-a}),c}});